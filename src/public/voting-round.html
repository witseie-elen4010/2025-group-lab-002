<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voting Round</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="voting-round.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
    const players = [
        new Player("Aaliyah", "Civilian"),
        new Player("Glen", "Civilian"),
        new Player("Noah", "Undercover"),
        new Player("Rizwaanah", "Mr. White")
    ];

    const votingRound = new VotingRound(players);
    let currentVoterIndex = 0;


    const voterLabel = document.getElementById("current-voter");
    const voteForSelect = document.getElementById("vote-for");
    const resultsDiv = document.getElementById("results");
    const voteForm = document.getElementById("vote-form");

    function initializeVoting() {
        voterLabel.textContent = `${players[currentVoterIndex].username}`;
        voteForSelect.innerHTML = ""; // Clear previous options
        players.forEach(player => {
            if (player.username !== players[currentVoterIndex].username) { // Exclude self-voting
                const option = document.createElement("option");
                option.value = player.username;
                option.textContent = `${player.username}`;
                voteForSelect.appendChild(option);
            }
        });

        updateVoteCounts(votingRound.votes);
    }

    voteForm.addEventListener("submit", async event => {
        event.preventDefault();
        const voteFor = voteForSelect.value;

        try {
            votingRound.castVote(players[currentVoterIndex].username, voteFor);

            // --- Send vote to backend ---
            // Find player IDs (simulate or map as needed)
            const voter = players[currentVoterIndex];
            const votedFor = players.find(p => p.username === voteFor);
            // For demo, use index+1 as ID (replace with real IDs if available)
            const player_id = currentVoterIndex + 1;
            const voted_for_id = players.findIndex(p => p.username === voteFor) + 1;
            const round_number = 1; // Replace with actual round logic if needed

            await fetch('/api/votes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ player_id, voted_for_id, round_number })
            });
            // --- End send vote ---

            currentVoterIndex++;

            if (currentVoterIndex < players.length) {
                initializeVoting(); 
            } else {
                updateVoteCounts(votingRound.votes);

                const eliminatedPlayer = votingRound.getEliminatedPlayer();

                if (Array.isArray(eliminatedPlayer)) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-warning" role="alert">
                            The votes resulted in a tie between: <strong>${eliminatedPlayer.join(", ")}</strong>. Restarting the voting process.
                        </div>
                    `;
                    currentVoterIndex = 0; 
                    votingRound.players.forEach(player => {
                        votingRound.votes[player.username] = 0; 
                    });
                    initializeVoting(); 
                } else {
                    resultsDiv.innerHTML = `
                    <div class="alert alert-success" role="alert">
                        <p> You eliminated a <strong>${eliminatedPlayer.role}</strong> </p>
                        <p> The player eliminated is: <strong>${eliminatedPlayer.username}</strong> </p>
                    </div>
                `;
                    voteForm.classList.add("d-none"); 
                }
            }
        } catch (error) {
            resultsDiv.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    Error: ${error.message}
                </div>
            `;
        }
    });


    initializeVoting();
});
    </script>
</head>

<body class="bg-light">
    <div class="container py-5">
        <h1 class="text-center mb-4">Voting Round</h1>
        <div class="card shadow-sm p-4">
            <form id="vote-form">
                <div class="mb-3">
                    <label class="form-label">Current Voter:</label>
                    <h4 id="current-voter" class="text-primary"></h4>
                </div>
                <div class="mb-3">
                    <label for="vote-for" class="form-label">Vote For:</label>
                    <select id="vote-for" class="form-select" required></select>
                </div>
                <button type="submit" class="btn btn-primary w-100">Cast Vote</button>
            </form>
            <div id="results" class="mt-4"></div>
        </div>

        <!-- Section to display vote counts -->
        <div class="card shadow-sm p-4 mt-4">
            <h5 class="card-title">Vote Counts</h5>
            <div id="vote-counts"></div>
        </div>
    </div>
</body>

</html>